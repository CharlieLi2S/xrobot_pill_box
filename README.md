# 智能药盒代码实现设计

## 功能

- [ ] 在规定时间内没有吃药时进行提醒

- [ ] 记录吃药状态（今天是否已吃药）

- [ ] 与手机端APP交互（设置吃药时间等，或者自动识别处方？）

- [ ] 自动取出要吃的药

- [ ] 扫码（处方）自动录入药的种类及吃药时间  

- [ ] 取几天需要的药

## 实现方案

核心：维护一个列表，根据列表以及输入来进行动作的输出

列表内容：

|      | 药盒编号 | 药盒中药的种类 | 吃药时间表 | 上次是否已吃 | 下次出药时间 | 下次提醒时间 |
| ---- | -------- | -------------- | ---------- | ------------ | ------------ | ------------ |
|      |          |                |            |              |              |              |

- 在规定时间内没有吃药时进行提醒：用计时器Timer计时，如果达到了列表中任意元素的下次提醒时间则进行提醒

  - 下次提醒时间：根据吃药频率计算提醒时间，如果上次未吃隔较短时间（如10min）后进行持续提醒

  - 提醒：语音播报/文字显示，可以把到了提醒时间的药用一个列表记录

    - 例如有一种A药是一天吃两次，那可以在把A药的吃药时间表记为[8:00, 20:00]；还有一种B药是6个小时吃一次，那就把B药的吃药时间表记为[0:00, 6:00, 12:00, 18:00]。

      假如现在是凌晨3点，那A药的下次提醒时间就是8:00，B药的下次提醒时间是6:00。

      到了6点自动取出一粒B药并将B加入提醒列表进行提醒，B药的上次是否已吃状态为未吃，下次提醒时间为6:10。到了6:10还未吃则变为6:20...

      直到8:00B药还未被取走，此时也到了A药的吃药时间，因此取出A药并将A也加入提醒列表进行提醒

      直到该药被取走后下次提醒时间变为12:00

- 与手机端APP交互（设置吃药时间等，或者自动识别处方？）

  - esp32开发板和手机接入同一个wifi以进行通信
  - 手机通过向开发板ip发送消息来设置吃药时间，消息的格式应该包含：药盒编号、药盒中药的种类、吃药时间表。开发板接收到消息之后新增或修改列表条目
  - esp32开发板将列表发送给手机，在手机app上显示
  - 用手机识别处方的功能在手机上完成，然后手机将其转换为上面的消息格式发送给esp32

- 自动取出要吃的药

  - 输入：要取的药的列表

  - 过程：遍历列表，根据要取的药的种类和数量调用电机转动转盘和滑轨及气泵进行吸取

    - 电机转动转盘：函数turn_disk(int pill_index)，其中参数pill_index是要取出的药所在的药盒编号，要求将指定的药盒转到待取位置

    - 吸取：函数pick_pill(int pill_number)，其中pill_number是要取出的数量，要求控制气泵和滑轨从待取位置进行pill_number次吸取动作



... 待补充666

